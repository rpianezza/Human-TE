---
title: "HGDP - Analyzing the TE abundance in the two sexes"
output: rmarkdown::github_document
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '/Users/rpianezza/TE/')
```


```{r}
library(tidyverse)
library(ggpubr)

theme_set(theme_bw())

HGDP <- read_delim("/Volumes/Temp1/rpianezza/0.old/summary-HGDP/HGDP_cutoff_classified.tsv")

a_HGDP <- read_tsv("/Volumes/Temp1/rpianezza/PCA-copynumber-all-analysis/a_HGDP.tsv")
HGDP_nobiased_samples <- filter(a_HGDP, (a > (-0.5)) & (a<0.5)) %>% select(ID) %>% pull()
HGDP_clean <- filter(HGDP, ID %in% HGDP_nobiased_samples)

DNA_names <- c("Crypton", "hAT", "Helitron", "Kolobok", "Mariner/Tc1", "Merlin", "MuDR", "piggyBac", "DNA transposon")
LINE_names <- c("L1", "CR1", "L2", "Crack", "RTE", "RTEX", "R4", "Vingi", "Tx1", "Penelope")
SINE_names <- c("SINE1/7SL", "SINE2/tRNA", "SINE3/5S", "SINE")
LTR_names <- c("ERV1", "ERV2", "ERV3", "Gypsy", "Endogenous Retrovirus", "LTR Retrotransposon", "Long terminal repeat", "Non-LTR Retrotransposon")
satellites_names <- c("Satellite", "satellite", "SAT")

classification <- HGDP_clean %>% mutate(class = case_when(superfamily %in% DNA_names ~ "DNA", superfamily %in% LINE_names ~ "LINE", superfamily %in% SINE_names ~ "SINE", superfamily %in% LTR_names ~ "LTR", superfamily %in% satellites_names ~ "satellite"))
```

# Sex differences

Male genome length = 6,045,293,052 bp
Female genome length = 5,948,152,252 bp

```{r}
f = 6045293052
m = 5948152252

diff_mf = f-m
diff_perc = (diff_mf/mean(f, m))*100

diff_perc
```

We expect a slight increase in females copynumber due to the bigger genome they have: **1.6%** bigger than males (Y chromosome is shorter than the X).

We chose a conservative threshold of **3.2%** to state that a TE copynumber is significantly different between the sexes despite the genome length difference.

```{r}
cn <- classification %>% filter(type=="te") %>% group_by(familyname, sex, class, superfamily) %>% summarise(mean = mean(copynumber)) %>% filter(mean>1) #%>% filter(mean < 1000)

(new_tibble <- tidyr::spread(cn, key = sex, value = mean))
colnames(new_tibble) <- c("familyname", "class", "superfamily", "female_cn", "male_cn")

(different_fem <- new_tibble %>% mutate(mean_cn = (female_cn+male_cn)/2, diff = abs(female_cn-male_cn)) %>% filter(diff > ((mean_cn/100)*3.2), diff>1) %>% arrange(desc(diff)))

(different_mal <- new_tibble %>% mutate(mean_cn = (female_cn+male_cn)/2, diff = abs(female_cn-male_cn)) %>% filter(diff > ((mean_cn/100)*1.6), diff>1) %>% arrange(desc(diff)))


(more_in_males <- different_mal %>% filter(male_cn>female_cn))
(more_in_females <- different_fem %>% filter(male_cn<female_cn))
```

```{r}
m_count <- more_in_males %>% ungroup() %>% summarise(count = n()) %>% pull()
f_count <- more_in_females %>% ungroup() %>% summarise(count = n()) %>% pull()
tot_count <- classification %>% filter(type=="te") %>% select(familyname) %>% distinct() %>% summarise(count = n()-(m_count+f_count)) %>% pull()
names <- c("More in males", "More in females", "No difference")

pie_tibble <- tibble(m_count, f_count, tot_count) %>% t() %>% as_tibble() %>% bind_cols(names) %>% rename("count" = "V1", "condition" = "...2") %>% relocate(condition, before = NULL)

pie_tibble <- pie_tibble %>% mutate(percent = count/sum(pie_tibble$count)*100)

(pie <- ggplot(pie_tibble, aes(x="", y=count, fill=condition))+
  geom_col(width = 1) + labs(fill='') +
  coord_polar(theta="y", start = pi/2)+
  theme_void()+
  geom_text(aes(label = count), 
            position = position_stack(vjust = 0.5), 
            size = 5))+
  theme(legend.position = "left")+
  scale_fill_manual(values=c("#FFFF33", "#FF9900", "#999999"))

#ggsave("/Volumes/Temp1/rpianezza/paper/figures/sex-diff-pie.png", pie, dpi = 300, width = 6, height = 6)
```

```{r}
females <- more_in_females %>% group_by(class) %>% summarise(count = n()) 

females <- females %>% mutate(percent = count/sum(females$count)*100)

sum_satellite_na <- females %>%
  filter(class %in% c("satellite", NA)) %>%
  summarise(count = sum(count),
            percent = sum(percent, na.rm = TRUE)) %>% mutate(class = "Other")

(females_mod <- females %>% filter(!(class %in% c("satellite", NA))) %>% bind_rows(sum_satellite_na))

x_values <- ifelse(females_mod$class == "Other", 1.3, 1.3)

(f_pie <- ggplot(females_mod, aes(x="", y=count, fill=class))+
  geom_col(width = 1) + labs(fill='') +
  coord_polar(theta="y")+
  theme_void()+
  geom_text(aes(x = 1.3, label = count), 
            position = position_stack(vjust = 0.5), 
            size = 5)+
  scale_color_manual(values=c("#F8766D", "#7CAE00", "#00BFC4", "#C77CFF")))
  

males <- more_in_males %>% group_by(class) %>% summarise(count = n()) 

males <- males %>% mutate(percent = count/sum(males$count)*100)

sum_satellite_na <- males %>%
  filter(class %in% c("satellite", NA)) %>%
  summarise(count = sum(count),
            percent = sum(percent, na.rm = TRUE)) %>% mutate(class = "Other")

(males_mod <- males %>% filter(!(class %in% c("satellite", NA))) %>% bind_rows(sum_satellite_na))

x_values <- ifelse(males_mod$class == "Other", 1.3, 1.3)

(m_pie <- ggplot(males_mod, aes(x="", y=count, fill=class))+
  geom_col(width = 1) + labs(fill='') +
  coord_polar(theta="y")+
  theme_void()+
  geom_text(aes(x = x_values, label = count), 
            position = position_stack(vjust = 0.5), 
            size = 5)+
  scale_fill_manual(values=c("#00BFC4", "#C77CFF")))

#ggsave("/Volumes/Temp1/rpianezza/paper/figures/male-diff-pie.png", m_pie, dpi = 300, width = 8, height = 6)
#ggsave("/Volumes/Temp1/rpianezza/paper/figures/female-diff-pie.png", f_pie, dpi = 300, width = 8, height = 6)
```

```{r}
sex_diff <- new_tibble %>% mutate(mean_cn = (female_cn+male_cn)/2, diff = abs(female_cn-male_cn), diff_normalized = diff/mean_cn) %>% filter(diff > 2, !(class %in% c("satellite", NA))) %>% arrange(desc(diff_normalized)) %>% filter(diff_normalized > 0.06)

(outliers_raw <- HGDP_clean %>% filter(type=="te", familyname %in% sex_diff$familyname) %>% inner_join(sex_diff, by="familyname"))
outliers <- outliers[order(outliers$diff_normalized,decreasing=T),]
outliers$familyname<-factor(outliers$familyname,levels=unique(outliers$familyname))

outliers_names <- outliers_raw %>% select(familyname) %>% distinct() %>% pull()
#results <- tibble()

#for (te in outliers_names){
#single_te <- outliers_raw %>% filter(familyname==te)
#result <- t.test(copynumber ~ sex, data = single_te)
#p_value <- result$p.value
#to_append <- tibble(te, p_value)
#results <- bind_rows(results, to_append)
#}

#(results <- results %>% rename(familyname=te))
#outliers <- inner_join(outliers_raw, results, by="familyname")
```

```{r}
#(scatter <- ggplot(outliers, aes(x = familyname, y = copynumber, fill = sex, color = class)) + geom_boxplot(notch = FALSE, width = 0.8, lwd = 0.2, outlier.size = 1.2) +
#theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
#scale_fill_manual(values = c("#FFFF33", "#FF9900")))

#scatter1 <- ggplot(outliers, aes(x = familyname, y = copynumber, fill = sex, color = class)) + geom_boxplot(notch = FALSE, width = 0.8, lwd = 0.2, outlier.size = 1) +
#theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
#scale_fill_manual(values = c("#FFFF33", "#FF9900")) +
#scale_color_manual(values = c("#7CAE00", "#00BFC4")) +
#ylim(0, 100))

#(scatter2 <- ggplot(outliers, aes(x = familyname, y = copynumber, fill = sex, color = class)) + geom_boxplot(notch = FALSE, width = 0.8, lwd = 0.2, outlier.size = 1) +
#theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
#scale_fill_manual(values = c("#FFFF33", "#FF9900")) +
#scale_color_manual(values = c("#7CAE00", "#00BFC4")) +
#ylim(140, 620))

#ggsave("/Volumes/Temp1/rpianezza/paper/figures-v2.0/sex/sex-diff-part1.png", scatter1, dpi = 1000, width = 8, height = 6)

#ggsave("/Volumes/Temp1/rpianezza/paper/figures-v2.0/sex/sex-diff-part2.png", scatter2, dpi = 1000, width = 8, height = 6)
```

```{r}
#m <- classification %>% filter(sex=="male") %>% select(ID) %>% summarise(individuals = n()) %>% pull()

#f <- classification %>% filter(sex=="female") %>% select(ID) %>% summarise(individuals = n()) %>% pull()

#(thanos <- classification %>% filter(type=="te") %>% group_by(sex) %>% summarise(total_te_sum = sum(copynumber), normalized_te_sum = if_else(sex=="female", total_te_sum/f, total_te_sum/m), kb=if_else(sex=="female", sum(copynumber*length)/f, sum(copynumber*length)/m)) %>% distinct())

#te_sum_m <- thanos %>% filter(sex=="male") %>% select(normalized_te_sum) %>% pull()
#te_sum_f <- thanos %>% filter(sex=="female") %>% select(normalized_te_sum) %>% pull()

#(percentage_diff <- ((te_sum_m - te_sum_f)/te_sum_f)*100)
```


# CV

```{r}
cn <- classification %>% filter(type=="te") %>% group_by(familyname, class, superfamily) %>% summarise(mean = mean(copynumber), var = var(copynumber), cv = var/mean) %>% arrange(desc(cv)) %>% filter(!(class %in% c("satellite", NA)), mean>1) %>% filter(cv > 1.58)

#outliers <- HGDP_clean %>% filter(type=="te", familyname %in% cn$familyname) %>% inner_join(cn, by="familyname")
#outliers <- outliers[order(outliers$cv,decreasing=T),]
#outliers$familyname<-factor(outliers$familyname,levels=unique(outliers$familyname))

#(box <- ggplot(outliers, aes(x=familyname, y=copynumber)) + geom_boxplot(notch=F, aes(color=class)) +
  #theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    #ylim(0,7000)+
 #scale_color_manual(values=c("#F8766D", "#7CAE00", "#00BFC4", "#C77CFF")))

#ggsave("/Volumes/Temp1/rpianezza/paper/figures-v2.0/cv/cn.png", box, dpi = 600, width = 8, height = 6)
```

```{r}
act_fam <- c("ALU","L1HS","L1PA2") #"SVA_A"

(correlation <- classification %>% filter(type=="te", class!="satellite") %>% group_by(familyname, sex, class) %>% summarise(mean = mean(copynumber), cv = (var(copynumber))/mean, var = var(copynumber)) %>% ungroup() %>% group_by(familyname, class, sex) %>% summarise(cn = mean(mean), cv = mean(cv), var=mean(var)) %>% mutate(activity=ifelse(familyname %in% act_fam, "yes", "no")))

cn10k <- correlation %>% filter(cn < 10000)
cn2k <- correlation %>% filter(cn < 2000)
cn100 <- correlation %>% filter(cn < 25)

(vplot1 <- ggplot(cn10k, aes(x = cn, y = cv, color = class)) +
  geom_point() +
  geom_text(aes(label=ifelse(familyname %in% act_fam, as.character(familyname), "")), color = "black", size=2.5, alpha = 1, nudge_y = 0.2) +
  geom_smooth(method = "lm", se = FALSE, color = "grey") +
  labs(x = "mean copynumber", y = "coefficient of variation")+
 scale_color_manual(values=c("#F8766D", "#7CAE00", "#00BFC4", "#D89000")))

(vplot2 <- ggplot(cn2k, aes(x = cn, y = cv, color = class)) +
  geom_point(aes(alpha = activity)) +
  geom_text(aes(label=ifelse(familyname %in% act_fam, as.character(familyname), "")), color = "black", size=2.5, alpha = 1, nudge_y = 0.1) +
  geom_smooth(method = "lm", se = FALSE, color = "grey") +
  labs(x = "copynumber", y = "cv")+
 scale_color_manual(values=c("#F8766D", "#7CAE00", "#00BFC4", "#D89000"))+
  scale_alpha_discrete(range = c(0.7, 1))+
  facet_grid(~sex)+
    theme(legend.position = "none"))

ggsave("/Volumes/Temp1/rpianezza/paper/figures/cv-2/var-cn.png", vplot2, dpi = 600, width = 8, height = 9)
#ggsave("/Volumes/Temp1/rpianezza/paper/figures-v2.0/cv/var-cn-supp.png", vplot1, dpi = 600, width = 8, height = 6)
```


```{r}
act_fam <- c("ALU","L1HS","SVA_A","L1PA2","HERVK")

(vplot1 <- ggplot(correlation, aes(x = log(cn), y = log(cv), color = class)) +
  geom_point() +
  geom_text(aes(label=ifelse(familyname %in% act_fam, as.character(familyname), "")), color = "black", size=2.5, alpha = 0.7, nudge_y = 0.3) +
  geom_smooth(method = "lm", se = FALSE, color = "grey") +
  labs(x = "mean copynumber (log)", y = "coefficient of variation (log)")+
 scale_color_manual(values=c("#F8766D", "#7CAE00", "#00BFC4", "#D89000")))
```


# Most abundant

```{r}
#(most_ab <- classification %>% filter(type=="te") %>% group_by(familyname, class, superfamily) %>% summarise(mean = mean(copynumber)) %>% filter(mean > 850) %>% arrange(desc(mean)))

#copyn <- classification %>% filter(type=="te") %>% group_by(familyname, class, superfamily) %>% summarise(mean = mean(copynumber))

#outliers <- HGDP_clean %>% filter(type=="te", familyname %in% most_ab$familyname) %>% inner_join(copyn, by="familyname")
#outliers <- outliers[order(outliers$mean,decreasing=T),]
#outliers$familyname<-factor(outliers$familyname,levels=unique(outliers$familyname))

#(box <- ggplot(outliers, aes(x=familyname, y=copynumber)) + geom_boxplot(notch=F, aes(color=class)) +
  #theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    #ylim(0,6500)+
 #scale_color_manual(values=c("#F8766D", "#7CAE00", "#00BFC4", "#C77CFF","#D89000")))

#(box_sat <- ggplot(outliers, aes(x=familyname, y=copynumber)) + geom_boxplot(notch=F, aes(color=class)) +
  #theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    #ylim(25000,80000)+
 #scale_color_manual(values=c("#C77CFF")))

#(box_alu <- ggplot(outliers, aes(x=familyname, y=copynumber)) + geom_boxplot(notch=F, aes(color=class)) +
  #theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    #ylim(160000,220000)+
 #scale_color_manual(values=c("#D89000")))

# Define the breaks and limits for the y-axis
#y_breaks <- c(0, 6000, 25000, 80000, 150000, 200000)
#y_limits <- c(0, 200000)

# Create the plot with discontinuous y-axis
#(box_disc <- ggplot(outliers, aes(x = familyname, y = copynumber)) +
  #geom_boxplot(notch = FALSE, aes(color = class)) +
  #theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  #scale_color_manual(values = c("#F8766D", "#7CAE00", "#00BFC4", "#C77CFF", "#D89000")) +
  #scale_y_continuous(breaks = y_breaks, limits = y_limits))


#ggsave("/Volumes/Temp1/rpianezza/paper/figures-v2.0/cv/copynumber1.png", box, dpi = 600, width = 8, height = 4)
#ggsave("/Volumes/Temp1/rpianezza/paper/figures-v2.0/cv/copynumber2.png", box_sat, dpi = 600, width = 8, height = 4)
#ggsave("/Volumes/Temp1/rpianezza/paper/figures-v2.0/cv/copynumber3.png", box_alu, dpi = 600, width = 8, height = 4)
```

# Other stuff

```{r}
library(scales)

#extract hex color codes for a plot with three elements in ggplot2 
hex <- hue_pal()(10)

#overlay hex color codes on actual colors
show_col(hex)
```

