---
title: "SNPs PCAs - Summary"
output: rmarkdown::github_document
editor_options: 
  markdown: 
    wrap: sentence
---

In this document I want to summarize the results we got on the SNPs PCAs in the HGDP. We decided to leave apart the SGDP, cause even if we were able to clean a bit the data, they still look confusing and of poor quality for our analysis.

In the previous scripts, we tried different filters for the dataset (HGDP) to clean it and refine our findings:

* **Filter on the samples**:
** Only **PCR-free** samples: the PCR samples are showing a different clustering in the PCA
** Only **GC-bias-free** samples: mostly overlapping with the PCR-free samples, cause most of the PCR-samples are also showing a GC-bias, as expected
** Only **PCR-free** samples *and* **GC-bias-free** samples: a few PCR samples does not show GC-bias, but here we exclude them anyway to avoid considering possible outliers of the PCR samples. This is the final filtering step of the dataset based on the samples.

* **Filter on the TEs families**:
** Only TEs with GC content 45-55%: the idea was that removing GC-biased TEs we were able to "save" the PCR samples, making them clustering around the PCR-free samples. This was not the case.
** Only variable TEs

* **Filter on SNPs type**:
** Only SNPs not involved in changes in GC content

Since we were not able to save the PCR-samples in any way, we decided in the end to consider **only samples PCR-free and GC-bias-free**, but to not further filter for TEs families or SNPs.

## Setting the environment
```{r}
library(tidyverse)
library(ggpubr)
```

# Preparing the filtered HGDP file

## Read HGDP summary file
```{r}
HGDP <- read_delim("/Volumes/Temp1/rpianezza/0.old/summary-HGDP/USEME_HGDP_complete_reflib6.2_mq10_batchinfo_cutoff0.01.txt")
names(HGDP) <- c("ID","pop","sex","country","type","familyname","length","reads","copynumber","batch")
```

## Filter out the PCR samples

From the initial 828 samples, we remain with 676 after removing the PCR samples.
```{r}
HGDP_pcr_free_samples <- read_tsv("/Volumes/Temp1/rpianezza/investigation/HGDP-no-PCR/HGDP-only-pcr-free-samples.tsv", col_names = "ID")
HGDP_pcr_free <- HGDP %>% filter(ID %in% HGDP_pcr_free_samples$ID)
```

## Filter out the GC-biased samples

From the 676 PCR-free samples, removing the GC-biased samples leads to a dataset with **655 samples** in total.

* 402 males
* 253 females

Note that **"a"** is the parabola quadratic coefficient which represent the GC-bias in every samples. If it's between -0.5 and 0.5, we assume that the GC-bias is not relevant in the sample. This procedure is better explained in the GC-bias script in "other documentation".
```{r}
a_HGDP <- read_tsv("/Volumes/Temp1/rpianezza/PCA-copynumber-all-analysis/a_HGDP.tsv")
HGDP_nobiased_samples <- filter(a_HGDP, (a > (-0.5)) & (a<0.5)) %>% select(ID) %>% pull()
HGDP_final <- filter(HGDP_pcr_free, ID %in% HGDP_nobiased_samples)
```

# PCA on the filtered dataset

## Read the SNPs matrix

```{r}
matrix <- "/Volumes/Temp1/rpianezza/0.old/SNP/mod.08.5000.matrix_processed_processed"
```

## Function for PCA plotting
```{r}
PCA_SNPs <- function(freq_matrix, metadata){

matrix <- read_csv(freq_matrix)
  
f_metadata <- metadata %>% filter(sex=="female") %>% select(ID, sex, country, pop) %>% distinct()
m_metadata <- metadata %>% filter(sex=="male") %>% select(ID, sex, country, pop) %>% distinct()
males_matrix <- inner_join(m_metadata, matrix, by="ID")
females_matrix <- inner_join(f_metadata, matrix, by="ID")

f_pca_data <- females_matrix %>%  select_if(~ !all(. == .[1]))
m_pca_data <- males_matrix %>%  select_if(~ !all(. == .[1]))
f_pca_result <- prcomp(f_pca_data[, -c(1:3)], center = TRUE, scale = TRUE)
m_pca_result <- prcomp(m_pca_data[, -c(1:3)], center = TRUE, scale = TRUE)

f_var_explained <- f_pca_result$sdev^2/sum(f_pca_result$sdev^2)
m_var_explained <- m_pca_result$sdev^2/sum(m_pca_result$sdev^2)
      
f <- ggplot(data.frame(f_pca_result$x, country=females_matrix$country), aes(x=PC1,y=PC2, color=country)) + geom_point(size=2, show.legend = FALSE) + labs(x=paste0("PC1: ",round(f_var_explained[1]*100,1),"%"), y=paste0("PC2: ",round(f_var_explained[2]*100,1),"%"))
   
m <- ggplot(data.frame(m_pca_result$x, country=males_matrix$country), aes(x=PC1,y=PC2, color=country)) + geom_point(size=2, show.legend = FALSE) + labs(x=paste0("PC1: ",round(m_var_explained[1]*100,1),"%"), y=paste0("PC2: ",round(m_var_explained[2]*100,1),"%"))
     
(plot <- ggarrange(f, m, ncol = 2, nrow = 1, common.legend = TRUE, legend = "bottom", align = "hv", font.label = list(size = 10, color = "black", face = "bold", family = NULL, position = "top")))
}
```

## PCA
```{r}
PCA_SNPs(matrix, HGDP_final)
```

### ANOVA

```{r}
PCA_SNPs_ANOVA <- function(freq_matrix, metadata){

matrix <- read_csv(freq_matrix)
  
f_metadata <- metadata %>% filter(sex=="female") %>% select(ID, sex, country, pop) %>% distinct()
m_metadata <- metadata %>% filter(sex=="male") %>% select(ID, sex, country, pop) %>% distinct()
males_matrix <- inner_join(m_metadata, matrix, by="ID")
females_matrix <- inner_join(f_metadata, matrix, by="ID")

f_pca_data <- females_matrix %>%  select_if(~ !all(. == .[1]))
m_pca_data <- males_matrix %>%  select_if(~ !all(. == .[1]))
f_pca_result <- prcomp(f_pca_data[, -c(1:3)], center = TRUE, scale = TRUE)
m_pca_result <- prcomp(m_pca_data[, -c(1:3)], center = TRUE, scale = TRUE)
      
f_var_explained <- f_pca_result$sdev^2/sum(f_pca_result$sdev^2)
m_var_explained <- m_pca_result$sdev^2/sum(m_pca_result$sdev^2)
      
# Create an empty tibble to store the results
results <- tibble()

# Perform ANOVA on PC1 and PC2 for the female samples
for (i in c(1:10)) {
  model <- aov(f_pca_result$x[,i] ~ females_matrix$country)
  summary_res <- summary(model)
  
# Extract the F value and p-value from the summary and the explained variability
f_value <- summary_res[[1]]$F[1]
p_value <- summary_res[[1]]$`Pr(>F)`[1]
explained_var <- (f_pca_result$sdev[i]^2/sum(f_pca_result$sdev^2))*100
  
  if (p_value < 0.001) {
significance <- "strong"
} else if (p_value >= 0.001 & p_value < 0.01) {
significance <- "moderate"
} else if (p_value >= 0.01 & p_value < 0.05) {
significance <- "weak"
} else if (p_value >= 0.05 & p_value < 0.1) {
significance <- "little"
} else {
significance <- "no-evidence"
}
  
# Store the results in the tibble
results <- results %>% bind_rows(tibble(PC = paste0("PC", i), Sex = "Female", F = f_value, p = p_value, Explained_Variability = explained_var, Significance = significance))
}

# Repeat the ANOVA analysis for the male samples
for (i in c(1:10)) {
  model <- aov(m_pca_result$x[,i] ~ males_matrix$country)
  summary_res <- summary(model)
  
# Extract the F value and p-value from the summary and the explained variability
f_value <- summary_res[[1]]$F[1]
p_value <- summary_res[[1]]$`Pr(>F)`[1]
explained_var <- (m_pca_result$sdev[i]^2/sum(m_pca_result$sdev^2))*100
  
  if (p_value < 0.001) {
significance <- "strong"
} else if (p_value >= 0.001 & p_value < 0.01) {
significance <- "moderate"
} else if (p_value >= 0.01 & p_value < 0.05) {
significance <- "weak"
} else if (p_value >= 0.05 & p_value < 0.1) {
significance <- "little"
} else {
significance <- "no-evidence"
}
  
# Store the results in the tibble
results <- results %>% bind_rows(tibble(PC = paste0("PC", i), Sex = "Male", F = f_value, p = p_value, Explained_Variability = explained_var, Significance = significance))
}

# Print the results
print(results)
}
```

```{r}
PCA_SNPs_ANOVA(matrix, HGDP_final)
```
