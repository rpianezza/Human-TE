---
title: "SNPs - ANOVA"
output: rmarkdown::github_document
editor_options: 
  markdown: 
    wrap: sentence
---

The SNPs PCA chosen after all the filtering steps shown in script 05 are:

* Only GC-bias-free samples
* Only PCR-free samples
* Only TEs within 45-55% range of GC
* Only GC-bias-free SNPs

## Prepare the environment

```{r env}
library(tidyverse)
library(ggpubr)
```

## Create list of non-variable TEs and other files

```{r non-variable TEs}
HGDP<-read_delim("/Volumes/Temp1/rpianezza/TE/summary-HGDP/USEME_HGDP_complete_reflib6.2_mq10_batchinfo_cutoff0.01.txt")
names(HGDP)<-c("ID","pop","sex","country","type","familyname","length","reads","copynumber","batch")
SGDP <- read_tsv("/Volumes/Temp2/rpianezza/SGDP/summary/USEME_SGDP_cutoff") %>% dplyr::rename(ID=biosample)
order <- c("Africa","America","Central Asia and Siberia","East Asia","West Eurasia","South Asia","Oceania")

HGDP_pcr_free_samples <- read_tsv("/Volumes/Temp1/rpianezza/investigation/HGDP-no-PCR/HGDP-only-pcr-free-samples.tsv", col_names = "ID")
HGDP_pcr_free <- HGDP %>% filter(ID %in% HGDP_pcr_free_samples$ID)
SGDP_pcr_free_samples <- read_tsv("/Volumes/Temp1/rpianezza/SGDP/ric-documentation/SGDP-no-PCR.tsv")
SGDP_pcr_free <- SGDP %>% filter(ID %in% SGDP_pcr_free_samples$ID)

a_HGDP <- read_tsv("/Volumes/Temp1/rpianezza/PCA-copynumber-all-analysis/a_HGDP.tsv")
HGDP_nobiased_samples <- filter(a_HGDP, (a > (-0.5)) & (a<0.5)) %>% select(ID) %>% pull()
HGDP_nobiasedID_pcrfree <- filter(HGDP_pcr_free, ID %in% HGDP_nobiased_samples)
a_SGDP <- read_tsv("/Volumes/Temp1/rpianezza/PCA-copynumber-all-analysis/a_SGDP.tsv")
SGDP_nobiased_samples <- filter(a_SGDP, (a > (-0.5)) & (a<0.5)) %>% select(ID) %>% pull()
SGDP_nobiasedID_pcrfree <- filter(SGDP_pcr_free, ID %in% SGDP_nobiased_samples)
```

## Read the SNPs matrixes

The SNPs matrixes are created using the script **frequency_matrix_v7.py**. This version of the script filters automatically the non-variable TEs in copynumber.

```{r SNP-matrixes}
HGDP_noGCbias_45_55 = "/Volumes/Temp1/rpianezza/PCA-SNPs-all-analysis/matrixes/only-variableTEs/HGDP.noGCbias.45-55.matrix_processed"
SGDP_noGCbias_45_55 = "/Volumes/Temp1/rpianezza/PCA-SNPs-all-analysis/matrixes/only-variableTEs/SGDP.noGCbias.45-55.matrix_processed"
```

## Create the function for PCA plotting

```{r main-function}
PCA_ANOVA <- function(freq_matrix, metadata){

matrix <- read_csv(freq_matrix)
  
f_metadata <- metadata %>% filter(sex=="female") %>% select(ID, sex, country, pop) %>% distinct()
m_metadata <- metadata %>% filter(sex=="male") %>% select(ID, sex, country, pop) %>% distinct()
males_matrix <- inner_join(m_metadata, matrix, by="ID")
females_matrix <- inner_join(f_metadata, matrix, by="ID")

f_pca_data <- females_matrix %>%  select_if(~ !all(. == .[1]))
m_pca_data <- males_matrix %>%  select_if(~ !all(. == .[1]))
f_pca_result <- prcomp(f_pca_data[, -c(1:3)], center = TRUE, scale = TRUE)
m_pca_result <- prcomp(m_pca_data[, -c(1:3)], center = TRUE, scale = TRUE)
      
f_var_explained <- f_pca_result$sdev^2/sum(f_pca_result$sdev^2)
m_var_explained <- m_pca_result$sdev^2/sum(m_pca_result$sdev^2)
      
# Create an empty tibble to store the results
results <- tibble()

# Perform ANOVA on PC1 and PC2 for the female samples
for (i in c(1:10)) {
  model <- aov(f_pca_result$x[,i] ~ females_matrix$country)
  summary_res <- summary(model)
  
# Extract the F value and p-value from the summary and the explained variability
f_value <- summary_res[[1]]$F[1]
p_value <- summary_res[[1]]$`Pr(>F)`[1]
explained_var <- (f_pca_result$sdev[i]^2/sum(f_pca_result$sdev^2))*100
  
  if (p_value < 0.001) {
significance <- "strong"
} else if (p_value >= 0.001 & p_value < 0.01) {
significance <- "moderate"
} else if (p_value >= 0.01 & p_value < 0.05) {
significance <- "weak"
} else if (p_value >= 0.05 & p_value < 0.1) {
significance <- "little"
} else {
significance <- "no-evidence"
}
  
# Store the results in the tibble
results <- results %>% bind_rows(tibble(PC = paste0("PC", i), Sex = "Female", F = f_value, p = p_value, Explained_Variability = explained_var, Significance = significance))
}

# Repeat the ANOVA analysis for the male samples
for (i in c(1:10)) {
  model <- aov(m_pca_result$x[,i] ~ males_matrix$country)
  summary_res <- summary(model)
  
# Extract the F value and p-value from the summary and the explained variability
f_value <- summary_res[[1]]$F[1]
p_value <- summary_res[[1]]$`Pr(>F)`[1]
explained_var <- (m_pca_result$sdev[i]^2/sum(m_pca_result$sdev^2))*100
  
  if (p_value < 0.001) {
significance <- "strong"
} else if (p_value >= 0.001 & p_value < 0.01) {
significance <- "moderate"
} else if (p_value >= 0.01 & p_value < 0.05) {
significance <- "weak"
} else if (p_value >= 0.05 & p_value < 0.1) {
significance <- "little"
} else {
significance <- "no-evidence"
}
  
# Store the results in the tibble
results <- results %>% bind_rows(tibble(PC = paste0("PC", i), Sex = "Male", F = f_value, p = p_value, Explained_Variability = explained_var, Significance = significance))
}

# Print the results
print(results)
}
```

```{r HGDP}
HGDP_nobiasSNPs_45to55_GC <- PCA_ANOVA(HGDP_noGCbias_45_55, HGDP_nobiasedID_pcrfree)
```

```{r SGDP}
SGDP_nobiasSNPs_45to55_GC <- PCA_ANOVA(SGDP_noGCbias_45_55, SGDP_nobiasedID_pcrfree)
```

## Explore other PCs in SGDP based on ANOVA test results

```{r}
PCA_SGDP <- function(freq_matrix, metadata, order){

matrix <- read_csv(freq_matrix)
  
f_metadata <- metadata %>% filter(sex=="female") %>% select(ID, sex, country, pop) %>% distinct()
m_metadata <- metadata %>% filter(sex=="male") %>% select(ID, sex, country, pop) %>% distinct()
f_metadata$country_reordered <- factor(f_metadata$country, levels=order)
m_metadata$country_reordered <- factor(m_metadata$country, levels=order)
males_matrix <- inner_join(m_metadata, matrix, by="ID")
females_matrix <- inner_join(f_metadata, matrix, by="ID")

f_pca_data <- females_matrix %>%  select_if(~ !all(. == .[1]))
m_pca_data <- males_matrix %>%  select_if(~ !all(. == .[1]))
f_pca_result <- prcomp(f_pca_data[, -c(1:4)], center = TRUE, scale = TRUE)
m_pca_result <- prcomp(m_pca_data[, -c(1:4)], center = TRUE, scale = TRUE)
     
f_var_explained <- f_pca_result$sdev^2/sum(f_pca_result$sdev^2)
m_var_explained <- m_pca_result$sdev^2/sum(m_pca_result$sdev^2)
        
f <- ggplot(data.frame(f_pca_result$x, country=females_matrix$country), aes(x=PC1,y=PC2, color=females_matrix$country_reordered)) + geom_point(size=2, show.legend = FALSE) + labs(x=paste0("PC2: ",round(f_var_explained[2]*100,1),"%"), y=paste0("PC4: ",round(f_var_explained[4]*100,1),"%"))
m <- ggplot(data.frame(m_pca_result$x, country=males_matrix$country), aes(x=PC1,y=PC2, color=males_matrix$country_reordered)) + geom_point(size=2, show.legend = FALSE) + labs(x=paste0("PC2: ",round(m_var_explained[2]*100,1),"%"), y=paste0("PC6: ",round(m_var_explained[6]*100,1),"%"))
       
plot <- ggarrange(f, m, ncol = 2, nrow = 1, common.legend = TRUE, legend = "bottom", align = "hv", font.label = list(size = 10, color = "black", face = "bold", family = NULL, position = "top"))
}

(PCA_SGDP(SGDP_noGCbias_45_55, SGDP_nobiasedID_pcrfree, order))
```
